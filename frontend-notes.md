# Notes on Jnet's server-client comms

The frontend html is defined in [pages.clj](src/clj/web/pages.clj). This
namespace defines index-page, which returns the index HTML, including a script
tag that loads `app10.js`, the transpiled cljs source.

[api.clj](src/clj/web/api.clj) then defines the default route

    (GET "/*" [] pages/index-page))

the routes (handled by [compojure](https://github.com/weavejester/compojure))
are then rolled into the `app` global along with some other guff.

[core.clj](src/clj/web/core.clj) then invokes an httpkit server with `app` as a
parameter.

The compiled frontend for prod includes

 - [src/cljs/nr](src/cljs/nr)
 - [src/cljs/prod](src/cljs/prod)
 - [src/cljc](src/cljc)


[src/cljs/prod/nr.cljs](src/cljs/prod/nr.cljs) invokes `nr.main/init!`, which
loads up top level react ([reagent](https://reagent-project.github.io/)) components.

## Handlers

There are a bunch of different "endpoints", in the loosest sense, for
client/server comms. In addition to the API endpoints defined in
[web.api](src/clj/web/api.clj), the server publishes a number of websockets
handlers for client-server communication. The client likewise publishes a set
of handlers for server-client communication.

The API endpoints are gathered together in a single file, but it is not so
simple to track down the websockets handlers. The lists below were generated by
inspecting app state in the repl. Specifically, for server-side handlers:

    => (in-ns 'web.ws)
    => (map println (sort (map first (seq @ws-handlers))))

Or client-side (using the Figwheel REPL):

    => (in-ns 'nr.ws)
    => (map println (sort (map first (seq @ws-handlers))))

### Server-side
The server defines the following websockets handlers which may be invoked by
the client:

    :chat/delete-all
    :chat/delete-msg
    :chat/say
    :chsk/uidport-close
    :chsk/uidport-open
    :chsk/ws-ping
    :lobby/create
    :lobby/deck
    :lobby/join
    :lobby/leave
    :lobby/rename-game
    :lobby/say
    :lobby/swap
    :lobby/watch
    :netrunner/action
    :netrunner/concede
    :netrunner/leave
    :netrunner/mute-spectators
    :netrunner/rejoin
    :netrunner/say
    :netrunner/start
    :netrunner/typing
    :tournament/create
    :tournament/delete
    :tournament/fetch

### Client-side
The client defines the following websockets handlers which may be invoked by the server:

    :chat/blocked
    :chat/delete-all
    :chat/delete-msg
    :chat/message
    :games/diff
    :games/list
    :lobby/notification
    :lobby/select
    :lobby/timeout
    :netrunner/diff
    :netrunner/start
    :netrunner/state
    :netrunner/timeout
    :stats/update
    :tournament/created
    :tournament/deleted
    :tournament/loaded
